<html>
    <head>
        <title>Negotiation Game: Where Should We Eat?</title>

	<style>

	  .clearfix {
	  overflow: auto;
	  }

	  .points {
	  color: #009933;
	  }

	  div#chat_container {
	  float:left;
	  width: 50%;
	  }

	  div#info_container {
	  margin-left: 52%;
	  }

	  textarea#chat {
	  width: 100%;
	  rows: 10;
	  cols: 100;
	  height: 25%;
	  }

	  img.heart {
	  height: 15px;
	  width: 15px;
	  }

	  img.dollar {
	  height: 16px;
	  width: 9px;
	  }

	  input#text {
	  width: 100%;
	  }
	  
	  td {
	  padding: 0 15px 0 15px;
	  }
	  
	  #instructions > p,li {
	  font-size:18px;
	  }
	  
	  table.sortable th:not(.sorttable_sorted):not(.sorttable_sorted_reverse):not(.sorttable_nosort):after { 
    	content: " \25B4\25BE" 
		}

#clockdiv{
    display: inline-block;
    font-weight: bold;
    text-align: center;
    font-size: 18px;
    padding: 15px 0 15px 0;
}

#clockdiv > div{
    display: inline-block;
}

#clockdiv div > span{
    display: inline-block;
}

#clockdiv div > .seconds{
	margin-left:-3px;
}

	</style>

		<script type="text/javascript" src="http://www.kryogenix.org/code/browser/sorttable/sorttable.js"></script> 
        <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
        <script type="text/javascript" charset="utf-8">
            var socket, validCheckInterval;
            $(document).ready(function(){
                socket = io.connect('http://' + document.domain + ':' + location.port+'/chat');
                socket.on('connect', function() {
                    socket.emit('joined', {});
                });
                socket.on('message', function(data) {
                    $('#chat').val($('#chat').val() + data.msg + '\n');
                    $('#chat').scrollTop($('#chat')[0].scrollHeight);
                });
                 socket.on('disconnect', function() {
 					socket.disconnect();
 					clearInterval(validCheckInterval);
 				});
				socket.on('endchat', function(data) {
					clearInterval(validCheckInterval);
					window.location.reload(true);
				});
               	$('#text').keypress(function(e) {
                    var code = e.keyCode || e.which;
                    if (code == 13) {
                        text = $('#text').val();
                        $('#text').val('');
                        socket.emit('text', {msg: text});
                    }
                });
	    		
	    		$('#ddRestaurants').change(function() {
	    			selected = $('option:selected').val();
                	socket.emit('pick', {restaurant: selected});
                });
                
				validCheckInterval = setInterval(pollServer, 3000);
            });
            
            function pollServer() {
            	socket.emit('is_chat_valid', {}, function(data) {
                    if (!data['valid']) { 
                        window.location.reload(true);   
                    }
                });
            }

        </script>
        
        <script type="text/javascript" charset="utf-8">
					function getTimeRemaining(endtime) {
					  var t = Date.parse(endtime) - Date.parse(new Date());
					  var seconds = Math.floor((t / 1000) % 60);
					  var minutes = Math.floor((t / 1000 / 60));
					  return {
					    'total': t,
					    'minutes': minutes,
					    'seconds': seconds
					  };
					}

					function initializeClock(id, endtime) {
					  var clock = document.getElementById(id);
					  var minutesSpan = clock.querySelector('.minutes');
					  var secondsSpan = clock.querySelector('.seconds');

					  function updateClock() {
					    var t = getTimeRemaining(endtime);

					    minutesSpan.innerHTML = t.minutes+':';
					    secondsSpan.innerHTML = ('0' + t.seconds).slice(-2);

					    if (t.total <= 0) {
					    	clearInterval(validCheckInterval);
					    	clearInterval(timeinterval);
					    	pollServer();
					    }
					  }

					  updateClock();
					  var timeinterval = setInterval(updateClock, 1000);
					}


					function init() {
					  var deadline = new Date(Date.parse(new Date()) + {{ num_seconds }} * 1000);
					  initializeClock('clockdiv', deadline);
				        }
        </script>
    </head>
    <body onload='init()'>
      <div class="clearfix">
    <div id="chat_container">
    <div id="instructions">
        <h1>Negotiation Game: Where Should We Eat?</h1>
        <p>
            It's Friday night, and you and your friend are trying to figure out where to eat dinner.
            You've discovered that there are <b>{{scenario["restaurants"]|length}}</b> restaurants nearby.
        </p>
	<h2>Instructions</h2>
	<ul>
	  <li> <b>Look at your list of preferred cuisines</b>, and <b>preferred price range</b>, at right. </li>
	  <li> Use the <b>chat box below</b> to chat with your friend and negotiate a restaurant to eat at. </li>
	  <li> Once you've <b>agreed on a restaurant</b>, select it from the <b>drop down list on the right</b>. You can select a restaurant as many times as you want, but the chat will only end when you and your friend both select the same restaurant.</li>
	</ul>
	<p><b>Use your negotiation skills well! </b> There will be a <b>bonus</b> for agreeing on a restaurant that matches your preferences as closely as possible.</p>
	</div>

        <div id="clockdiv" align="right">
	  Time Remaining: 
	  <div>
	    <span class="minutes"></span>
	    <span class="seconds"></span>
	  </div>
	</div>

        <textarea readonly id="chat"></textarea><br><br>
        <input id="text" placeholder="Enter your message here"><br><br>

    </div>

    <div id="info_container">
        <div id="preferences">

            <h3>Your cuisine preferences</h3>
            <table class="cuisine_preferences_list">
				{% for cuisine in agent["cuisine_func"] %}
					<tr>
						<td>{{cuisine["cuisine"]}} </td>
						<td>
						{% if config["numerical_preferences"] %} 
						<span class="points"> ({{ cuisine["utility"] }} points) </span> 
						{% else %} 
						{% for i in range(cuisine["utility_rating"]) %} <img src="{{ url_for('static', filename='img/heart.svg') }}" class="heart"/> {% endfor %}
						{% endif %} 
						</td>
				  </tr>
					{% endfor %}
			</table>

            <h3>Your price range preference</h3>

	    {% if config["numerical_prices"] %} 
	    <ul>
	      {% for obj in agent["spending_func"] %}
              <li>
		${{ obj["price_range"][0] }} - ${{ obj["price_range"][1] }}
	      </li>
	      <span class="points"> ({{ obj["utility"] }} points) </span> </li>
              {% endfor %}
	    </ul>

            {% else %}
            {% for i in range((agent["spending_func"][0]["price_rating"]) | int) %} 
              <img src="{{ url_for('static', filename='img/dollar.png') }}" class="dollar"/> 
            {% endfor %}
            {% endif %}

            <h3>Restaurants nearby</h3>
	    <table class="sortable">
	    <thead>
	    <tr>
	    <th>Name</th>
	    <th>Cuisine</th>
	    <th class="sorttable_numeric">Price range</th>
	    </tr>
	    </thead>
	    <tbody>
            {% for restaurant in scenario["restaurants"] %}
            <tr>
				<td><b>{{ restaurant["name"] }}</b></td>
				<td>{{ restaurant["cuisine"]}}</td> 
				
				<td sorttable_customkey="{{restaurant['price_rating'] | int}}">
				  {% if config["numerical_prices"] %} 
				  ${{ restaurant["price_range"][0] }} - ${{ restaurant["price_range"][1] }}
					  {% else %}
						{% for i in range((restaurant["price_rating"]) | int) %} 
					  <img src="{{ url_for('static', filename='img/dollar.png') }}" class="dollar"/> 
						{% endfor %}
					{% endif %}
				</td>
	    	</tr>
	    {% endfor %}
	    </tbody>
	    </table>
        </div>

        	<h3>Choose a restaurant below:</h3>
            <select id="ddRestaurants">
            	<option value="-1">Select a restaurant</option>
                {% set ctr = 0 %}
                {% for restaurant in scenario["restaurants"] %}
                <option value={{ctr}}>{{ restaurant["name"] }}</option>
                {% set ctr = ctr + 1 %}
                {% endfor %}
            </select>

    </div>
    </div>
    </body>
</html>
